(function(){"use strict";var d=(e=>(e.VIEW="1",e.CLICK="2",e.LOAD="3",e))(d||{});function y(e){return/^(local.)?([act]-tech|newmos).mos.ru$|^([actr].)?local.mos-team.ru$/.test(e)}const m=y(window.location.hostname)?`${window.location.protocol}//${window.location.hostname}`:"https://www.mos.ru",S=m;function v({element:e,containerId:t}){return e??(t?document.getElementById(t):null)}function f(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)e[o]=r[o]}return e}var $={read:function(e){return e[0]==='"'&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function p(e,t){function r(n,i,c){if(!(typeof document>"u")){c=f({},t,c),typeof c.expires=="number"&&(c.expires=new Date(Date.now()+c.expires*864e5)),c.expires&&(c.expires=c.expires.toUTCString()),n=encodeURIComponent(n).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var a="";for(var s in c)c[s]&&(a+="; "+s,c[s]!==!0&&(a+="="+c[s].split(";")[0]));return document.cookie=n+"="+e.write(i,n)+a}}function o(n){if(!(typeof document>"u"||arguments.length&&!n)){for(var i=document.cookie?document.cookie.split("; "):[],c={},a=0;a<i.length;a++){var s=i[a].split("="),V=s.slice(1).join("=");try{var _=decodeURIComponent(s[0]);if(c[_]=e.read(V,_),n===_)break}catch{}}return n?c[n]:c}}return Object.create({set:r,get:o,remove:function(n,i){r(n,"",f({},i,{expires:-1}))},withAttributes:function(n){return p(this.converter,f({},this.attributes,n))},withConverter:function(n){return p(f({},this.converter,n),this.attributes)}},{attributes:{value:Object.freeze(t)},converter:{value:Object.freeze(e)}})}var l=p($,{path:"/"});function g(){return g=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},g.apply(this,arguments)}function C(e,t){if(e==null)return{};var r={},o=Object.keys(e),n,i;for(i=0;i<o.length;i++)n=o[i],!(t.indexOf(n)>=0)&&(r[n]=e[n]);return r}var O=["eventLoc","eventRef"],j="https://stats.mos.ru/eds.gif?o=";function L(){return Math.round(Date.now()/1e3)}function R(){var e=document.cookie.replace(/(?:(?:^|.*;\s*)mos_id\s*=\s*([^;]*).*$)|^.*$/,"$1")||null;return e}function U(e){var t=e.eventLoc,r=e.eventRef,o=C(e,O),n=window!==window.parent,i=n&&t||window.location.href,c=n&&r||window.document.referrer;return encodeURIComponent(JSON.stringify(g({eventDst:"stats",mosId:R(),eventTime:L(),eventLoc:i,eventRef:c},o)))}function T(e){var t=U(e),r=new Image;r.src=""+j+t}function x(e,t,r){return fetch(e,{method:r||"GET",body:t}).then(n=>n.status<200||n.status>=300?Promise.reject(n.statusText):n.json())}async function D(e){const t=`${m}/api/schmetterling/v2/frontend/json/ru`,r=encodeURIComponent(l.get("mos_id")??""),o=encodeURIComponent(window.location.href);return x(`${t}/platforms/${e}?targetUrl=${o}${r?`&mosId=${r}`:""}`).then(n=>{var i,c;return(n==null?void 0:n.status)==="failed"?Promise.reject(new Error(((i=n==null?void 0:n.error)==null?void 0:i.message)??`Ошибка получения баннера для площадки ${e}`)):n!=null&&n.banner?(c=n==null?void 0:n.banner)!=null&&c.html?n:Promise.reject(new Error(`Данных не найдено для площадки ${e}`)):Promise.reject(new Error(`Баннер не найден для площадки ${e}`))})}function A({id:e,campaignId:t,tags:r,platformId:o}){return{banner_id:e.toString(10),campaign_id:t.toString(10),place_id:o.toString(10),place_group_id:JSON.stringify(r.map(n=>n.id.toString(10)))}}function E({id:e,url:t,targetTypes:r,platformId:o},n){return{b_id:e,eventSrc:t,eventObject:{b_pl:o,type:r!=null&&r.includes("segment")?"stats":"editorial",click:n===d.CLICK||void 0,view:n===d.VIEW||void 0,load:n===d.LOAD||void 0}}}function h(e,t){var n,i;const r=new Date,o={user_id:"",type:"schmetterling",payload:{event_name:e,mos_id:l.get("mos_id"),client_id:l.get("_ym_uid"),url:(n=window.top)==null?void 0:n.location.href,useragent:(i=window.top)==null?void 0:i.navigator.userAgent,isad:l.get("_ym_isad"),...A(t)},created_at:r.toLocaleString("ru-RU",{timeZone:"Europe/Moscow"}).replace(/(\d+).(\d+).(\d+), (.+)/,"$3-$2-$1 $4")};fetch(`${m}/api/analytics-forwarder/v1/events`,{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}}).catch(()=>{}),T({...E(t,e),eventType:"b_net",eventTime:r.getTime()})}function P(e,t){const r=new IntersectionObserver(o=>{o[0].isIntersecting&&(r.disconnect(),t())},{root:null,rootMargin:"0px",threshold:.5});return r.observe(e),r}function M(e,t,r,o){e.innerHTML="";const n=document.createElement("iframe");return n.setAttribute("scrolling","no"),n.style.border="none",n.style.display="inline-block",n.style.width="1px",n.style.minWidth="100%",n.style.height="100%",n.srcdoc=t,n.onload=()=>{r&&n.contentDocument&&n.contentDocument.body.addEventListener("click",r),o&&o()},e.appendChild(n),n}function H({html:e,url:t}){return e=e.replace(/<head>/i,`<head><base href="${S}">`),t?e.replace(/<a(.*?)href=["'].*?["']/g,"<a$1"):e}function B(e){if(!e.url)return;let t="_blank";try{t=new URL(e.url).hostname===window.location.hostname?"_parent":"_blank"}catch{}return r=>{r.isTrusted&&(h(d.CLICK,e),window.open(e.url??"",t))}}async function F(e){const t=v(e),{params:{platform:r},onLoad:o,onRender:n}=e;if(!t)throw new Error("Контейнер не найден");const{banner:i}=await D(r);if(!i)throw new Error(`Баннер не найден для площадки ${r}`);h(d.LOAD,i),o&&await o();const c=M(t,H(i),B(i),n),a=P(c,()=>{h(d.VIEW,i)});return{createArgs:e,data:i,observer:a}}const u=[];function W(e){u.push(e)}function k(e){u.splice(u.indexOf(e),1)}function q(e){u.forEach(t=>e(t))}function I(e){const t=typeof e=="string";return u.find(({createArgs:{containerId:r,element:o}})=>t&&r&&r===e||!t&&o&&o.isEqualNode(e)||t&&(o==null?void 0:o.id)&&o.id===e)}function w(e){var r;if(!e||!((r=e.params)!=null&&r.platform))throw Error("Некорректные аргументы для инициализации");const{onError:t}=e;F(e).then(({createArgs:o,...n})=>{W({...n,createArgs:{...o,element:v(e)}})}).catch(o=>{t&&t(o)})}function b(e,t=!1){const r=I(e),o=r&&v(r.createArgs);o&&(r.observer&&r.observer.disconnect(),t||(o.innerHTML=""),k(r))}function z(e){if(e){const t=I(e);t&&(b(e,!0),w(t.createArgs))}else q(({createArgs:t})=>{t.element&&b(t.element,!0),w(t)})}const J=Object.freeze(Object.defineProperty({__proto__:null,create:w,reload:z,destroy:b},Symbol.toStringTag,{value:"Module"}));typeof window.Schmetterling>"u"&&(window.Schmetterling=J)})();
